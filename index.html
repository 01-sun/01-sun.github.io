	<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<meta name="author" content="litou">
		<meta name="description" content="Site Description">
		<meta name="generator" content="Hugo 0.81.0" />
		<title>LITOU&#39;s BLOG</title>
		<link rel="shortcut icon" href="https://01-sun.github.io/images/favicon.ico">
		<link rel="stylesheet" href="https://01-sun.github.io/css/style.css">
		<link rel="stylesheet" href="https://01-sun.github.io/css/highlight.css">

		
		<link rel="stylesheet" href="https://01-sun.github.io/css/font-awesome.min.css">
		

		

		
	</head>

	<body>
    <nav class="main-nav">
	
	
	<a href='https://01-sun.github.io/posts'>Archive</a>
	<a href='https://01-sun.github.io/tags'>Tags</a>
	<a href='https://01-sun.github.io/about'>About</a>

	

	
</nav>


    <div class="profile">
    <section id="wrapper">
        <header id="header">
            <a href='https://01-sun.github.io/about'>
                <img id="avatar" class="2x" src="https://01-sun.github.io/images/avatar.png"/>
            </a>
            <h1>LITOU&#39;s BLOG</h1>
            <h2>自由 游戏 海龟先生</h2>
        </header>
    </section>
</div>


    <section id="wrapper" class="home">
        <ul id="post-list">
    
    
        
            <li>
                <aside class="dates">Feb 24</aside>
                <a href='https://01-sun.github.io/post/lua%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E7%AC%94%E8%AE%B0/'>
                    Lua设计与实现-笔记
                    
                        
                            <h2>前言 用了一年多的lua，却对这个语言只是止于使用，乘着过年放假，把这本《lua设计与实现》读完。作者用最通俗易懂的语言讲述lua的底层实现，对lua从数据类型到虚拟机，再到回收机制进行层层剖析，使得笔者对lua有大体了解，而又好记性不如烂笔头，因此作此笔记。
 通用数据类型 目标： 不同时刻同一变量指向不同数据类型
思路：需要两个字段，一个存储数据类型，一个存储数据
实现：通过union和struct，之间嵌套、有机结合形成lua_TValue，来统一表示所有数据类型。可进行GC（垃圾回收）操作的数据有CommonHeader宏定义的成员
注：number不是可GC类型
lua通用数据结构组织（如图）
 字符串-string 目标：尽可能提高效率存储字符串
思路：存储字符串的变量是对该字符串的引用，所以需要两个字段，一个存储字符串的长度，一个存储字符串数据的引用（散列值）
实现：
typedef uinion TString{ L_Umaxalign dumy; //对齐变量 （节省空间）  struct{ commonHeader; //GC宏  lu_byte reserved; //表示是不是保留字符串  unsigned int hash;//散列值  size_t len; //字符串长度  }tsu; }TString; 特点：
“内化”：字符串变量是对字符串的引用，当创建字符串前先检查全局数据区有无该串，无则创建，有则引用。（ps：用时间换空间，同时lua的查找算法效率也很高）
“散列值”：加快对字符串数据比较和查找
存储：
所有字符串存储在全局数据区，该区为全局变量global_state的str成员,str本质为散列数组
typedef struct stringtable{ GCObject **hash; lu_int32 nuse; //元素值  int size; }stringtable; 创建字符串Tstring，首先根据散列算法算出散列值，为str的索引值，若位置上已有值，则用链表串联起来
rehash（重新哈希）:当散列桶中数量非常大，算法效率急速下降，所以需要重新分配散列桶数量，来降低每个桶中的数量（luaS_resize()）
lua_Tip:
尽量少用大量循环来连接字符串，因为每次连接都会产生新串，费时又费空间。而用表来做字符串缓冲区（先用表循环存储，再用table.concat连接），会节省空间,提高效率。
 表-table 目标：存储所有数据类型，并对使用者透明
思路：两个部分，分数组和散列表
实现：
type struct Table{ CommonHeader; lu_byte flags; //提供元方法标志  lu_byte lsizenode; //以2为第的散列桶大小  struct Table *metable; //远比闹  TValue *array; //数组部分指针  Node *node; //散列桶起始位置  Node *lastfree; //散列桶最后位置  GCObject *gclist; int sizearray; //数组部分大小 } 重要操作</h2>
                        
                    
                </a>
            </li>
        
    
</ul>

        <nav id="post-nav">
    
</nav>
        <footer id="footer">
    
        <div id="social">

	
	
    <a class="symbol" href="https://github.com/01-sun">
        <i class="fa fa-github-square"></i>
    </a>
    


</div>

    
    <p class="small">
    
       © Copyright 2021 <i class="fa fa-heart" aria-hidden="true"></i> litou
    
    </p>
    <p class="small">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a href="https://github.com/nodejh/hugo-theme-cactus-plus">nodejh</a>
    </p>
</footer>

    </section>

    <script src="https://01-sun.github.io/js/jquery-3.3.1.min.js"></script>
<script src="https://01-sun.github.io/js/main.js"></script>
<script src="https://01-sun.github.io/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>







    </body>
</html>
